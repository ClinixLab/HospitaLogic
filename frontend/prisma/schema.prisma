generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "mysql"
}

model Patient {
  patient_id String @id @db.Char(36) // = Login.user_id
  name       String
  gender     String
  phone      String

  pii          PatientPII?
  appointments Appointment[]
  treatments   Treatment[]
  bills        Bill[]

  login Login @relation(fields: [patient_id], references: [user_id])
}

model PatientPII {
  patient_id String   @id @db.Char(36)
  DOB        DateTime
  address    String

  patient Patient @relation(fields: [patient_id], references: [patient_id])
}

model Diagnosis {
  diagnosis_id Int    @id @default(autoincrement())
  code         String
  description  String
  treatments   Treatment[]
}

model Department {
  department_id Int @id @default(autoincrement())
  name          String
  location      String

  doctors     Doctor[]
  specialties Specialty[]   
}

model Specialty {
  specialty_id  Int @id @default(autoincrement())
  name          String
  description   String

  department_id Int?         
  department    Department?  @relation(fields: [department_id], references: [department_id])

  doctors Doctor[]

  @@index([department_id])
}
model Doctor {
  doctor_id     String @id @db.Char(36) // = Login.user_id
  name          String
  phone         String
  department_id Int
  specialty_id  Int

  treatments   Treatment[]
  appointments Appointment[]

  department Department @relation(fields: [department_id], references: [department_id])
  specialty  Specialty  @relation(fields: [specialty_id], references: [specialty_id])

  login Login @relation(fields: [doctor_id], references: [user_id])
}

model Appointment {
  appointment_id Int      @id @default(autoincrement())
  patient_id     String   @db.Char(36)
  doctor_id      String   @db.Char(36)
  date           DateTime
  time           String
  status         String

  patient Patient @relation(fields: [patient_id], references: [patient_id])
  doctor  Doctor  @relation(fields: [doctor_id], references: [doctor_id])

  @@unique([doctor_id, date, time], name: "uniq_doctor_slot")
}

model Treatment {
  treatment_id   Int      @id @default(autoincrement())
  patient_id     String   @db.Char(36)
  doctor_id      String   @db.Char(36)
  diagnosis_id   Int
  treatment_date DateTime

  medicines      TreatmentMedicine[]
  billTreatments BillTreatment[]

  patient   Patient   @relation(fields: [patient_id], references: [patient_id])
  doctor    Doctor    @relation(fields: [doctor_id], references: [doctor_id])
  diagnosis Diagnosis @relation(fields: [diagnosis_id], references: [diagnosis_id])
}

model Medicine {
  medicine_id Int     @id @default(autoincrement())
  name        String
  quantity    Int
  price       Decimal @db.Decimal(10, 2)

  usedIn TreatmentMedicine[]
}

model TreatmentMedicine {
  treatment_medicine_id Int @id @default(autoincrement())
  treatment_id          Int
  medicine_id           Int
  quantity              Int

  treatment Treatment @relation(fields: [treatment_id], references: [treatment_id])
  medicine  Medicine  @relation(fields: [medicine_id], references: [medicine_id])
}

model Bill {
  bill_id        Int      @id @default(autoincrement())
  patient_id     String   @db.Char(36)
  total_amount   Decimal  @db.Decimal(10, 2)
  payment_status String
  bill_date      DateTime

  treatments BillTreatment[]
  patient    Patient @relation(fields: [patient_id], references: [patient_id])
}

model BillTreatment {
  bill_treatment_id Int @id @default(autoincrement())
  bill_id           Int
  treatment_id      Int @unique

  bill      Bill      @relation(fields: [bill_id], references: [bill_id])
  treatment Treatment @relation(fields: [treatment_id], references: [treatment_id])
}

enum Role {
  PATIENT
  DOCTOR
}

model Login {
  user_id         String @id @default(uuid()) @db.Char(36) // ✅ UUID
  username        String @unique
  hashed_password String
  role            Role

  patient    Patient?
  doctor     Doctor?
  accessLogs AccessLog[]
}

model AccessLog {
  access_id   Int      @id @default(autoincrement())
  user_id     String   @db.Char(36)
  entity_type String
  entity_id   String   @db.VarChar(64) // ถ้า entity_id เคยเก็บ int ก็ยังเก็บเป็น string ได้
  action      String
  access_time DateTime @default(now())

  user Login @relation(fields: [user_id], references: [user_id])
}
